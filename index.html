<!doctype>
<html>
  <head>
    <meta charset="utf-8">
    <script src="./dist/ldclient.js"></script>
  </head>
  <body>
    <h1>Production Settings</h1>
    <ul>
      <li><code>client-side-flag</code>: <span class="prod-client-side-flag">initializing…</span></li>
      <li><code>another-client-side-flag</code>: <span class="prod-another-client-side-flag">initializing…</span></li>
    </ul>
    
    <button class="prod-switch-user">Change user</button>
    <button class="prod-change-hash">Change hash fragment</button>
    <button class="prod-change-url">Change url</button>

    <h1>Test Settings</h1>
    <ul>
      <li><code>client-side-flag</code>: <span class="test-client-side-flag">initializing…</span></li>
      <li><code>another-client-side-flag</code>: <span class="test-another-client-side-flag">initializing…</span></li>
    </ul>
    
    <button class="test-switch-user">Change user</button>
    <button class="test-change-hash">Change hash fragment</button>
    <button class="test-change-url">Change url</button>
    
    <script>
      var switched = false;
      var user = {key: 'foobar.com'};
      var clientProd = LDClient.initialize('5a3ad672761af020881a8816', user);
      var clientTest = LDClient.initialize('5a3ad672761af020881a8815', user);

      function main(env) {
        render(env, 'client-side-flag', false);
        render(env, 'another-client-side-flag', false);
        // setTimeout(main, 2000);
      }
      
      function render(env, key, defaultValue) {
        var value = clientProd.variation(key, defaultValue);
        var el = document.querySelector('.' + env + '-' + key);
        el.innerHTML = value.toString();
      }

      //production
      clientProd.on('ready', function() {
        console.log('client is ready');
        main('prod');
      });
      
      clientProd.on('change', function(settings) {
        console.log('flags changed:', settings);
        main('prod');
      });
      
      clientProd.on('change:another-client-side-flag', function(value, previous) {
        console.log('another-client-side-flag changed:', value, '(' + previous + ')');
        main('prod');
      });
    
      
      document.querySelector('.prod-switch-user').addEventListener('click', function(event) {
        var key = switched ? 'foobar.com' : 'barfoo.com';
        clientProd.identify({key: key}, null, function() {
          switched = !switched;
          console.log('switched to', key);
          render('another-client-side-flag', false);
        });
      });
      document.querySelector('.prod-change-hash').addEventListener('click', function(event) {
        location.hash = new Date().getTime().toString();
      });
      document.querySelector('.prod-change-url').addEventListener('click', function(event) {
        history.pushState(null, null, new Date().getTime().toString());
      });

      //test
      clientTest.on('ready', function() {
        console.log('client is ready');
        main('test');
      });
      
      clientTest.on('change', function(settings) {
        console.log('flags changed:', settings);
        main('test');
      });
      
      clientTest.on('change:another-client-side-flag', function(value, previous) {
        console.log('another-client-side-flag changed:', value, '(' + previous + ')');
        main('test');
      });
      
      document.querySelector('.test-switch-user').addEventListener('click', function(event) {
        var key = switched ? 'foobar.com' : 'barfoo.com';
        clientTest.identify({key: key}, null, function() {
          switched = !switched;
          console.log('switched to', key);
          render('another-client-side-flag', false);
        });
      });
      document.querySelector('.test-change-hash').addEventListener('click', function(event) {
        location.hash = new Date().getTime().toString();
      });
      document.querySelector('.test-change-url').addEventListener('click', function(event) {
        history.pushState(null, null, new Date().getTime().toString());
      });
    </script>
  </body>
</html>